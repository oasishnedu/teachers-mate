<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Teachers' Mate (ë‹´ì„ver.)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <link rel="icon" type="image/png" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-512.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TeachersMate">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.474.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase ëª¨ë“ˆ ë¡œë“œ -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      window.FirebaseUtils = {
        initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut,
        getFirestore, doc, setDoc, onSnapshot
      };
      window.dispatchEvent(new Event('firebase-loaded'));
    </script>

    <style>
        @font-face {
          font-family: 'NanumSquareRound';
          src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_two@1.0/NanumSquareRound.woff') format('woff');
          font-weight: normal;
          font-style: normal;
        }
        body { 
            font-family: 'NanumSquareRound', -apple-system, sans-serif; 
            background-color: #fdfbf7; 
            color: #292524;
            -webkit-tap-highlight-color: transparent;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        input, button, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // =========================================================================
        // ğŸ”’ [ë³´ì•ˆ ì„¤ì •] ì´ê³³ì— ë°œê¸‰ë°›ì€ Firebase ë³´ì•ˆ í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
        // =========================================================================
        const USER_FIREBASE_CONFIG = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_PROJECT_ID.firebasestorage.app",
          messagingSenderId: "YOUR_SENDER_ID",
          appId: "YOUR_APP_ID"
        };
        // =========================================================================

        const isCanvas = typeof __firebase_config !== 'undefined';
        const firebaseConfig = isCanvas ? JSON.parse(__firebase_config) : USER_FIREBASE_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'teachers-mate-github';

        // --- ê³µí†µ ë³€ìˆ˜ ë° ìœ í‹¸ë¦¬í‹° ---
        const Icon = ({ name, size = 20, className = "", strokeWidth = 2 }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    iconRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    iconRef.current.appendChild(i);
                    window.lucide.createIcons({ root: iconRef.current, attrs: { width: size, height: size, 'stroke-width': strokeWidth } });
                }
            }, [name, size, strokeWidth]);
            return <span ref={iconRef} className={`inline-flex items-center justify-center ${className}`}></span>;
        };

        const INITIAL_HOLIDAYS = {
          '2026-01-01': 'ì‹ ì •', '2026-02-16': 'ì„¤ë‚  ì—°íœ´', '2026-02-17': 'ì„¤ë‚ ', '2026-02-18': 'ì„¤ë‚  ì—°íœ´',
          '2026-03-01': 'ì‚¼ì¼ì ˆ', '2026-03-02': 'ëŒ€ì²´ê³µíœ´ì¼', '2026-05-05': 'ì–´ë¦°ì´ë‚ ', '2026-05-24': 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', '2026-05-25': 'ëŒ€ì²´ê³µíœ´ì¼',
          '2026-06-03': 'ì§€ë°©ì„ ê±°ì¼', '2026-06-06': 'í˜„ì¶©ì¼', '2026-08-15': 'ê´‘ë³µì ˆ', '2026-09-24': 'ì¶”ì„ ì—°íœ´', '2026-09-25': 'ì¶”ì„', '2026-09-26': 'ì¶”ì„ ì—°íœ´',
          '2026-10-03': 'ê°œì²œì ˆ', '2026-10-09': 'í•œê¸€ë‚ ', '2026-12-25': 'ê¸°ë…íƒ„ì‹ ì¼'
        };
        const DEFAULT_TIMETABLE = { 1: Array(8).fill(''), 2: Array(8).fill(''), 3: Array(8).fill(''), 4: Array(8).fill(''), 5: Array(8).fill('') };
        const ATTENDANCE_SUB_TYPES = ['ì§ˆë³‘', 'ê°ì—¼ë³‘', 'ê²½ì¡°ì‚¬', 'ìƒë¦¬', 'ê¸°íƒ€', 'ë¯¸ì¸ì •', 'ì¥ê¸°'];
        
        const getFormatDate = (date) => {
          const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0');
          return `${y}-${m}-${d}`;
        };

        const exportToExcel = (filename, headers, data) => {
          if (typeof XLSX === 'undefined') return alert('ì—‘ì…€ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ì‹œë„í•´ì£¼ì„¸ìš”.');
          const worksheet = XLSX.utils.aoa_to_sheet([headers, ...data]);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
          XLSX.writeFile(workbook, filename);
        };

        const openGoogleSheets = () => {
          window.open('https://docs.google.com/spreadsheets/', '_blank');
        };

        // --- ì¸ì¦ í™”ë©´ ë° ê°€ì´ë“œ ---
        function SetupGuideScreen() {
           return (
             <div className="min-h-screen bg-[#fdfbf7] flex flex-col items-center justify-center p-6">
                <div className="bg-white p-8 rounded-3xl shadow-xl max-w-2xl w-full border border-stone-100">
                   <h1 className="text-2xl font-black text-rose-600 mb-4 flex items-center gap-2"><Icon name="shield-alert" size={28} /> ë³´ì•ˆ ì„œë²„(Firebase) ì—°ê²° ëŒ€ê¸° ì¤‘</h1>
                   <div className="text-stone-600 mb-6 text-sm leading-relaxed space-y-4">
                     <p>í•™ìƒë“¤ì˜ <strong>ë¯¼ê°í•œ ê°œì¸ì •ë³´ë¥¼ íƒ€ì¸ìœ¼ë¡œë¶€í„° ì•ˆì „í•˜ê²Œ ë³´í˜¸</strong>í•˜ê¸° ìœ„í•´ êµ¬ê¸€ ë¡œê·¸ì¸ ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                     <p>ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ì„ ìƒë‹˜ë§Œì˜ ë…ë¦½ì ì¸ ë¬´ë£Œ ë°ì´í„°ë² ì´ìŠ¤(Firebase) ì—°ê²° ì„¤ì •ì´ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.</p>
                     <div className="bg-rose-50/50 p-5 rounded-xl border border-rose-100 mt-4">
                        <h3 className="font-bold text-stone-800 mb-3 flex items-center gap-2"><Icon name="settings" size={18}/> ì„¤ì • ì§„í–‰ ë°©ë²•</h3>
                        <ol className="list-decimal pl-5 space-y-2 text-stone-700 font-medium">
                           <li>í•¨ê»˜ ì œê³µëœ <strong>[GitHub ì–´í”Œ ë°°í¬ ê°€ì´ë“œ]</strong> ë¬¸ì„œì˜ <strong>'ë‹¨ê³„ 0: êµ¬ê¸€ ë¡œê·¸ì¸ ì„¤ì •í•˜ê¸°'</strong>ë¥¼ ë”°ë¼ Firebase í‚¤ë¥¼ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤.</li>
                           <li>ë‹¤ìš´ë¡œë“œí•˜ì‹  <code>index.html</code> íŒŒì¼ì„ ë©”ëª¨ì¥(ë˜ëŠ” ì½”ë“œ ì—ë””í„°)ìœ¼ë¡œ ì—½ë‹ˆë‹¤.</li>
                           <li>ì½”ë“œ ìœ—ë¶€ë¶„ì— ìˆëŠ” <code>USER_FIREBASE_CONFIG</code> ë¶€ë¶„ì„ ì°¾ì•„ ë°œê¸‰ë°›ì€ í‚¤ ê°’ìœ¼ë¡œ êµì²´í•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.</li>
                           <li>ìƒˆë¡œ ì €ì¥ëœ íŒŒì¼ì„ ë‹¤ì‹œ GitHubì— ì—…ë¡œë“œí•˜ë©´ ë°”ë¡œ ë¡œê·¸ì¸ì´ í™œì„±í™”ë©ë‹ˆë‹¤!</li>
                        </ol>
                     </div>
                   </div>
                </div>
             </div>
           );
        }

        function LoginScreen() {
          const [error, setError] = useState('');
          const [isLoading, setIsLoading] = useState(false);

          const handleLogin = async () => {
            setIsLoading(true);
            setError('');
            try {
              const { getAuth, signInWithPopup, GoogleAuthProvider, signInWithCustomToken, signInAnonymously } = window.FirebaseUtils;
              const auth = getAuth();

              if (typeof __firebase_config !== 'undefined') {
                  // ìº”ë²„ìŠ¤(ë¯¸ë¦¬ë³´ê¸°) í™˜ê²½ì—ì„œëŠ” íŒì—…ì´ ì°¨ë‹¨ë˜ë¯€ë¡œ ìë™/ìµëª… ë¡œê·¸ì¸ìœ¼ë¡œ ì‹œì—°
                  if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                      await signInWithCustomToken(auth, __initial_auth_token);
                  } else {
                      await signInAnonymously(auth);
                  }
              } else {
                  // ì‹¤ì œ ë°°í¬(GitHub) í™˜ê²½ìš© êµ¬ê¸€ ë¡œê·¸ì¸
                  const provider = new GoogleAuthProvider();
                  provider.setCustomParameters({ prompt: 'select_account' });
                  await signInWithPopup(auth, provider);
              }
            } catch (e) {
              console.error("Login Error:", e);
              let errorMsg = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message;
              if (e.code === 'auth/unauthorized-domain') {
                  errorMsg = 'ë„ë©”ì¸ ìŠ¹ì¸ ì˜¤ë¥˜: Firebase [Authentication -> ì„¤ì • -> ìŠ¹ì¸ëœ ë„ë©”ì¸]ì— ì ‘ì†í•˜ì‹  ì£¼ì†Œ(github.io)ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”!';
              } else if (e.code === 'auth/operation-not-allowed') {
                  errorMsg = 'ë¡œê·¸ì¸ ì„¤ì • ì˜¤ë¥˜: Firebase [Authentication -> Sign-in method]ì—ì„œ "Google"ì„ ì¶”ê°€í•˜ê³  ì‚¬ìš© ì„¤ì •í•´ì£¼ì„¸ìš”!';
              } else if (e.code === 'auth/popup-closed-by-user') {
                  errorMsg = 'ë¡œê·¸ì¸ ì°½ì´ ì¤‘ê°„ì— ë‹«í˜”ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
              }
              setError(errorMsg);
            } finally {
              setIsLoading(false);
            }
          };

          return (
            <div className="min-h-screen bg-[#fdfbf7] flex flex-col items-center justify-center p-6">
              <div className="bg-white p-10 rounded-3xl shadow-xl max-w-md w-full border border-stone-100 text-center">
                <div className="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner"><Icon name="shield-check" size={40} /></div>
                <h1 className="text-2xl font-black text-stone-800 mb-2">Teachers' Mate</h1>
                <p className="text-stone-500 font-medium mb-8 leading-relaxed">ì„ ìƒë‹˜ì˜ ì†Œì¤‘í•œ í•™ê¸‰ ë°ì´í„°ë¥¼<br/>ì•ˆì „í•˜ê²Œ ë³´í˜¸í•˜ê¸° ìœ„í•´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                
                {error && (
                    <div className="mb-6 p-4 bg-rose-50 border border-rose-200 rounded-xl text-left">
                        <p className="text-rose-600 text-sm font-bold leading-relaxed break-keep">{error}</p>
                    </div>
                )}

                <button onClick={handleLogin} disabled={isLoading} className="w-full py-4 bg-emerald-600 text-white font-bold rounded-2xl shadow-md hover:bg-emerald-700 active:scale-95 transition-all flex justify-center items-center gap-2 disabled:bg-stone-300">
                   <Icon name="log-in" size={18} /> {isLoading ? 'ë¡œê·¸ì¸ ì¤‘...' : 'êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì‹œì‘í•˜ê¸°'}
                </button>
              </div>
            </div>
          );
        }

        // --- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì»´í¬ë„ŒíŠ¸ ---
        function MainApp({ user, db }) {
          const [isLoaded, setIsLoaded] = useState(false);
          const isLoadedRef = useRef(false);

          const [activeTab, setActiveTab] = useState('calendar');
          const [currentDate, setCurrentDate] = useState(new Date());
          const [selectedDate, setSelectedDate] = useState(null); 

          // ë™ê¸°í™”ë˜ëŠ” ìƒíƒœ ë°ì´í„°
          const [students, setStudents] = useState([]);
          const [attendance, setAttendance] = useState({});
          const [fieldTrips, setFieldTrips] = useState([]);
          const [counseling, setCounseling] = useState([]);
          const [todos, setTodos] = useState({});
          const [memos, setMemos] = useState({});
          const [holidays, setHolidays] = useState(INITIAL_HOLIDAYS);
          const [customEvents, setCustomEvents] = useState({});
          const [timetable, setTimetable] = useState(DEFAULT_TIMETABLE);
          const [evaluations, setEvaluations] = useState([]);
          const [maxFieldDays, setMaxFieldDays] = useState(15);
          const [docLink, setDocLink] = useState('https://school.use.go.kr/guyeong-e/M010404/view/3325138?');

          // UI ì œì–´ ìƒíƒœ
          const [rosterInput, setRosterInput] = useState('');
          const [isEventModalOpen, setIsEventModalOpen] = useState(false);
          const [selectedStudentForModal, setSelectedStudentForModal] = useState(null);
          const [selectedFtStudent, setSelectedFtStudent] = useState(null);
          const [selectedFtEvent, setSelectedFtEvent] = useState(null);
          const [ftForm, setFtForm] = useState({ studentId: '', startDate: '', startTime: '00:00', endDate: '', place: '', isNeisDone: false });
          const [dmDrafts, setDmDrafts] = useState({}); 
          const [dmMemoText, setDmMemoText] = useState('');
          const [dmShowMonthEval, setDmShowMonthEval] = useState(false);
          const [isEditingLink, setIsEditingLink] = useState(false);
          const [tempLink, setTempLink] = useState('');
          const fileInputRef = useRef(null);

          // ì„œë²„ ë°ì´í„° ìµœì´ˆ ë¶ˆëŸ¬ì˜¤ê¸°
          useEffect(() => {
            const { doc, onSnapshot } = window.FirebaseUtils;
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'userData', 'state');
            const unsub = onSnapshot(docRef, (snap) => {
                if (snap.exists() && !isLoadedRef.current) {
                    const data = snap.data();
                    setStudents(data.students || []); setAttendance(data.attendance || {}); setFieldTrips(data.fieldTrips || []);
                    setCounseling(data.counseling || []); setTodos(data.todos || {}); setMemos(data.memos || {});
                    setHolidays(data.holidays || INITIAL_HOLIDAYS); setCustomEvents(data.customEvents || {});
                    setTimetable(data.timetable || DEFAULT_TIMETABLE); setEvaluations(data.evaluations || []);
                    setMaxFieldDays(data.maxFieldDays || 15); setDocLink(data.docLink || 'https://school.use.go.kr/guyeong-e/M010404/view/3325138?');
                    setIsLoaded(true); isLoadedRef.current = true;
                } else if (!snap.exists() && !isLoadedRef.current) {
                    setIsLoaded(true); isLoadedRef.current = true;
                }
            });
            return () => unsub();
          }, [user, db]);

          // ì„œë²„ ë°ì´í„° ì‹¤ì‹œê°„ ë°±ê·¸ë¼ìš´ë“œ ì €ì¥ (Debounce)
          useEffect(() => {
            if (!isLoadedRef.current) return;
            const { doc, setDoc } = window.FirebaseUtils;
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'userData', 'state');
            const dataToSave = { students, attendance, fieldTrips, counseling, todos, memos, holidays, customEvents, timetable, evaluations, maxFieldDays, docLink };
            const timer = setTimeout(() => { setDoc(docRef, dataToSave, { merge: true }).catch(console.error); }, 1500);
            return () => clearTimeout(timer);
          }, [students, attendance, fieldTrips, counseling, todos, memos, holidays, customEvents, timetable, evaluations, maxFieldDays, docLink, db, user]);

          // ëª…ë ¬í‘œ í…ìŠ¤íŠ¸ ì—ì–´ë¦¬ì–´ ë™ê¸°í™”
          useEffect(() => { if (rosterInput === '' && students.length > 0) setRosterInput(students.map(s => s.name).join('\n')); }, [students]);
          useEffect(() => { setDmMemoText(selectedDate ? (memos[selectedDate] || '') : ''); }, [selectedDate, memos]);

          const handleLogout = async () => {
             const { getAuth, signOut } = window.FirebaseUtils;
             await signOut(getAuth());
          };

          const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
          const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
          const startDayIndex = firstDayOfMonth.getDay();
          const daysInMonth = lastDayOfMonth.getDate();
          const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
          const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));

          const calculateDeadline = (startDateStr) => {
              if (!startDateStr) return '';
              let date = new Date(startDateStr); let count = 0;
              while (count < 4) {
                  date.setDate(date.getDate() - 1);
                  const day = date.getDay(); const dStr = getFormatDate(date);
                  if (!(day === 0 || day === 6) && !holidays[dStr]) count++;
              }
              return getFormatDate(date);
          };
          const calculateReportDeadline = (endDateStr) => {
              if (!endDateStr) return ''; let date = new Date(endDateStr); date.setDate(date.getDate() + 7); return getFormatDate(date);
          };
          const calculateDuration = (start, end, time) => {
              if (!start || !end) return 0;
              const diffDays = Math.ceil((new Date(end).getTime() - new Date(start).getTime()) / (1000 * 60 * 60 * 24)) + 1;
              if (diffDays <= 0) return 0;
              return time === '12:20' ? diffDays - 0.5 : diffDays;
          };

          const studentStats = useMemo(() => {
            const stats = {};
            students.forEach(s => { stats[s.id] = { absent: 0, early: 0, late: 0, missed: 0, field: 0, ftCount: 0, ftRecords: [] }; });
            Object.values(attendance).forEach(dayRecords => {
              dayRecords.forEach(record => {
                if (stats[record.studentId]) {
                  if (record.type === 'ê²°ì„') stats[record.studentId].absent++;
                  if (record.type === 'ì¡°í‡´') stats[record.studentId].early++;
                  if (record.type === 'ì§€ê°') stats[record.studentId].late++;
                  if (record.type === 'ê²°ê³¼') stats[record.studentId].missed++;
                }
              });
            });
            fieldTrips.forEach(ft => {
               if (stats[ft.studentId]) { stats[ft.studentId].field += ft.duration; stats[ft.studentId].ftCount++; stats[ft.studentId].ftRecords.push(ft); }
            });
            return stats;
          }, [students, attendance, fieldTrips]);

          const renderCalendar = () => {
            const days = []; const todayStr = getFormatDate(new Date());
            for (let i = 0; i < startDayIndex; i++) days.push(<div key={`empty-${i}`} className="h-24 bg-stone-50/50 border border-stone-100 rounded-2xl"></div>);
            
            for (let d = 1; d <= daysInMonth; d++) {
              const dateObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), d);
              const dateStr = getFormatDate(dateObj);
              const dayOfWeek = dateObj.getDay();
              const holiday = holidays[dateStr];
              const customEvent = customEvents[dateStr];
              const hasTodo = todos[dateStr]?.some(t => !t.done);
              const hasMemo = memos[dateStr]?.trim().length > 0;
              const hasAttendance = attendance[dateStr]?.length > 0;
              const hasCounseling = counseling.some(c => c.date === dateStr);
              const hasFieldTrip = fieldTrips.some(ft => dateStr >= ft.startDate && dateStr <= ft.endDate);
              const isToday = dateStr === todayStr;

              days.push(
                <div key={d} onClick={() => { setSelectedDate(dateStr); setDmShowMonthEval(false); }}
                  className={`h-28 border rounded-2xl p-3 cursor-pointer transition-all hover:border-emerald-400 hover:shadow-md flex flex-col justify-between
                    ${isToday ? 'bg-emerald-50/80 border-emerald-400 shadow-sm' : (dayOfWeek === 0 || holiday) ? 'bg-rose-50/40 border-stone-100' : dayOfWeek === 6 ? 'bg-sky-50/40 border-stone-100' : 'bg-white border-stone-100'}`}
                >
                  <div>
                    <div className="flex justify-between items-start">
                      <span className={`font-bold ${isToday ? 'text-emerald-600' : dayOfWeek === 0 || holiday ? 'text-rose-400' : dayOfWeek === 6 ? 'text-sky-400' : 'text-stone-600'}`}>{d}</span>
                      <div className="flex gap-1 flex-wrap justify-end max-w-[50%]">
                        {hasTodo && <span className="w-2 h-2 rounded-full bg-emerald-400" title="í•  ì¼" />}
                        {hasMemo && <span className="w-2 h-2 rounded-full bg-amber-400" title="ë©”ëª¨" />}
                        {hasAttendance && <span className="w-2 h-2 rounded-full bg-rose-400" title="ì¶œê²°" />}
                        {hasFieldTrip && <span className="w-2 h-2 rounded-full bg-blue-500" title="êµì™¸ì²´í—˜" />}
                        {hasCounseling && <span className="w-2 h-2 rounded-full bg-sky-400" title="ìƒë‹´" />}
                      </div>
                    </div>
                    {(holiday || customEvent) && (
                      <div className="mt-1.5 flex flex-col gap-1">
                        {holiday && <span className="text-[10px] px-1.5 py-0.5 bg-rose-100/80 text-rose-600 rounded-md truncate font-semibold">{holiday}</span>}
                        {customEvent && <span className="text-[10px] px-1.5 py-0.5 bg-emerald-100/80 text-emerald-700 rounded-md truncate font-semibold">{customEvent}</span>}
                      </div>
                    )}
                  </div>
                </div>
              );
            }
            return days;
          };

          const renderFieldTrip = () => {
            const handleFormChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFtForm(prev => {
                    const next = { ...prev, [name]: type === 'checkbox' ? checked : value };
                    if (name === 'startDate' && (!next.endDate || next.endDate < value)) next.endDate = value;
                    return next;
                });
            };

            const previewDuration = calculateDuration(ftForm.startDate, ftForm.endDate, ftForm.startTime);
            const deadline = calculateDeadline(ftForm.startDate);
            const reportDeadline = calculateReportDeadline(ftForm.endDate);

            const handleAddFieldTripForm = () => {
                if (!ftForm.studentId || !ftForm.startDate || !ftForm.endDate) return alert('í•™ìƒê³¼ ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                const newRecord = { id: Date.now(), ...ftForm, duration: previewDuration, deadline, reportDeadline, isNeisRequested: ftForm.isNeisDone, isAppReceived: false, isReportDone: false };
                setFieldTrips([...fieldTrips, newRecord]);
                setFtForm({ studentId: '', startDate: '', startTime: '00:00', endDate: '', place: '', isNeisDone: false });
            };

            const updateFtInfo = (id, key, value) => {
                setFieldTrips(prev => prev.map(ft => ft.id === id ? { ...ft, [key]: value } : ft));
                if (selectedFtEvent && selectedFtEvent.id === id) setSelectedFtEvent(prev => ({ ...prev, [key]: value }));
            };

            const handleExportFT = () => {
                const headers = ['ë²ˆí˜¸', 'ì´ë¦„', 'ì´ ì‚¬ìš© ì¼ìˆ˜', 'ì”ì—¬ ì¼ìˆ˜', 'ì‹ ì²­ íšŸìˆ˜', 'ìµœê·¼ ì²´í—˜í•™ìŠµì¼'];
                const data = [...students].sort((a,b)=>a.number - b.number).map(s => {
                    const stats = studentStats[s.id];
                    const remaining = maxFieldDays - stats.field;
                    const recentDate = stats.ftRecords.length > 0 ? [...stats.ftRecords].sort((a,b)=>b.startDate.localeCompare(a.startDate))[0].startDate : '-';
                    return [s.number, s.name, stats.field, remaining, stats.ftCount, recentDate];
                });
                exportToExcel('êµì™¸ì²´í—˜_ëˆ„ì ëª…ë¶€.xlsx', headers, data);
            };

            return (
              <div className="flex flex-col lg:flex-row gap-6">
                <aside className="w-full lg:w-80 flex flex-col gap-5 flex-none">
                  <div className="bg-white p-6 rounded-3xl shadow-sm border border-stone-100">
                      <h2 className="font-bold text-lg mb-5 flex items-center gap-2 text-emerald-700"><Icon name="plus-circle" /><span>ì‹ ê·œ ì²´í—˜í•™ìŠµ ë“±ë¡</span></h2>
                      <div className="space-y-4">
                          <select name="studentId" value={ftForm.studentId} onChange={handleFormChange} className="w-full p-3.5 bg-stone-50 rounded-xl outline-none text-sm font-bold text-stone-700">
                              <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                              {[...students].sort((a,b)=>a.number - b.number).map(s => <option key={s.id} value={s.id}>{s.number}ë²ˆ {s.name}</option>)}
                          </select>
                          <div className="grid grid-cols-1 gap-3">
                              <div>
                                  <label className="text-xs font-bold text-stone-400 ml-1 mb-1 block">ì‹œì‘ì¼ ë° ì‹œê°„</label>
                                  <div className="flex gap-1.5">
                                      <input type="date" name="startDate" value={ftForm.startDate} onChange={handleFormChange} className="flex-1 p-3 bg-stone-50 rounded-xl text-sm" />
                                      <select name="startTime" value={ftForm.startTime} onChange={handleFormChange} className="w-28 p-3 bg-stone-50 rounded-xl text-xs font-bold">
                                          <option value="00:00">ì˜¤ì „ 00:00</option><option value="12:20">ì˜¤í›„ 12:20</option>
                                      </select>
                                  </div>
                              </div>
                              <div>
                                  <label className="text-xs font-bold text-stone-400 ml-1 mb-1 block">ì¢…ë£Œì¼</label>
                                  <input type="date" name="endDate" value={ftForm.endDate} onChange={handleFormChange} className="w-full p-3 bg-stone-50 rounded-xl text-sm" />
                              </div>
                          </div>
                          {ftForm.startDate && ftForm.endDate && (<div className="text-center bg-emerald-50 p-2.5 rounded-xl text-emerald-700 text-sm font-bold border border-emerald-100">ì´ ì²´í—˜ ê¸°ê°„: {previewDuration}ì¼</div>)}
                          <input name="place" value={ftForm.place} onChange={handleFormChange} placeholder="ì¥ì†Œ ë° ê°„ë‹¨í•œ ë‚´ìš©" className="w-full p-3.5 bg-stone-50 rounded-xl text-sm" />
                          <label className="flex items-center gap-2 px-1 cursor-pointer">
                              <input type="checkbox" name="isNeisDone" checked={ftForm.isNeisDone} onChange={handleFormChange} className="w-4 h-4 accent-emerald-500" />
                              <span className="text-sm font-bold text-stone-600">NEISí•™ë¶€ëª¨ì„œë¹„ìŠ¤</span>
                          </label>
                          <div className="grid grid-cols-2 gap-3 mt-2">
                              <div className="p-3 bg-rose-50 rounded-xl border border-rose-100 text-center"><div className="text-xs font-bold text-rose-400 mb-1">ì‹ ì²­ ë§ˆê°ì¼</div><div className="text-base font-black text-rose-600">{deadline || '-'}</div></div>
                              <div className="p-3 bg-blue-50 rounded-xl border border-blue-100 text-center"><div className="text-xs font-bold text-blue-400 mb-1">ë³´ê³  ë§ˆê°ì¼</div><div className="text-base font-black text-blue-600">{reportDeadline || '-'}</div></div>
                          </div>
                          <button onClick={handleAddFieldTripForm} className="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition shadow-sm mt-2 flex justify-center items-center gap-2"><Icon name="check" size={18} /> ì²´í—˜í•™ìŠµ ë“±ë¡</button>
                      </div>
                  </div>
                  <div className="bg-white p-6 rounded-3xl shadow-sm border border-stone-100 overflow-hidden flex flex-col flex-1 min-h-[250px] max-h-[350px]">
                      <h2 className="font-bold text-lg mb-4 text-stone-700 flex items-center gap-2"><Icon name="clock" size={18} className="text-emerald-500"/> ìµœê·¼ ë“±ë¡ëœ ì¼ì •</h2>
                      <div className="overflow-y-auto space-y-3 pr-1 scrollbar-hide">
                          {fieldTrips.length === 0 ? <p className="text-stone-400 text-center py-8 text-sm">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p> :
                          [...fieldTrips].sort((a,b)=>b.id - a.id).map(ft => {
                              const st = students.find(s=>s.id === ft.studentId);
                              return (
                              <div key={ft.id} onClick={() => setSelectedFtEvent(ft)} className="p-4 bg-stone-50 rounded-2xl border border-transparent hover:border-emerald-200 cursor-pointer transition-all">
                                  <div className="flex justify-between items-center mb-1"><div className="font-extrabold text-stone-700">{st?.name}</div><span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-lg font-bold">{ft.duration}ì¼</span></div>
                                  <div className="text-xs text-stone-500 font-medium">{ft.startDate.slice(5)} ~ {ft.endDate.slice(5)} ({ft.startTime === '12:20' ? 'ì˜¤í›„' : 'ì˜¤ì „'})</div>
                              </div>
                          )})}
                      </div>
                  </div>
                </aside>

                <section className="flex-1 bg-white rounded-3xl shadow-sm border border-stone-100 flex flex-col overflow-hidden min-h-[500px]">
                  <div className="p-6 border-b border-stone-100 flex flex-col gap-4 bg-stone-50/50">
                      <div className="flex justify-between items-start">
                          <div>
                              <h2 className="text-xl font-bold text-stone-800 flex items-center gap-2"><Icon name="bus" size={24} className="text-emerald-500" /> í•™ìƒë³„ ì²´í—˜í•™ìŠµ ëˆ„ì  ëª…ë¶€</h2>
                              <p className="text-sm text-stone-500 mt-1">ì¢Œì¸¡ì—ì„œ ë“±ë¡ëœ ë‚´ì—­ì´ ì´ê³³ê³¼ <strong>ì¶œê²° í†µê³„</strong>ì— ì—°ë™ë˜ì–´ ìë™ í•©ì‚°ë©ë‹ˆë‹¤.</p>
                          </div>
                          <div className="flex gap-2">
                             <button onClick={handleExportFT} className="px-3 py-2 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded-xl hover:bg-emerald-100 font-bold transition-colors text-sm flex items-center shadow-sm gap-1.5"><Icon name="download" size={16} /> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                             <button onClick={openGoogleSheets} className="px-3 py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-xl hover:bg-blue-100 font-bold transition-colors text-sm flex items-center shadow-sm gap-1.5"><Icon name="table" size={16} /> ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°</button>
                          </div>
                      </div>
                      <div className="flex items-center">
                          <div className="bg-white border border-stone-200 rounded-xl px-4 py-2 text-sm text-stone-600 font-medium flex items-center gap-2">
                              ì—°ê°„ ê·œì •: <input type="number" value={maxFieldDays} onChange={(e) => setMaxFieldDays(Number(e.target.value) || 0)} className="w-14 text-center font-bold text-emerald-600 text-lg bg-emerald-50 border border-emerald-100 rounded-lg outline-none" min="0"/>
                              <span className="font-bold text-emerald-600 text-lg">ì¼</span>
                          </div>
                      </div>
                  </div>
                  
                  <div className="overflow-x-auto flex-1">
                      <table className="w-full text-left border-collapse min-w-[600px]">
                          <thead>
                              <tr className="bg-stone-50/50 border-b border-stone-100 text-stone-500 text-sm">
                                  <th className="p-4 font-bold pl-6">í•™ìƒ ì´ë¦„</th>
                                  <th className="p-4 font-bold text-center">ì´ ì‚¬ìš© ì¼ìˆ˜</th>
                                  <th className="p-4 font-bold text-center">ì”ì—¬ ì¼ìˆ˜</th>
                                  <th className="p-4 font-bold text-center">ì‹ ì²­ íšŸìˆ˜</th>
                                  <th className="p-4 font-bold text-center">ìµœê·¼ ì²´í—˜í•™ìŠµì¼</th>
                              </tr>
                          </thead>
                          <tbody>
                              {students.length === 0 ? (
                                  <tr><td colSpan="5" className="p-10 text-center text-stone-400 font-medium">ëª…ë ¬í‘œë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.</td></tr>
                              ) : [...students].sort((a,b)=>a.number - b.number).map(student => {
                                  const stats = studentStats[student.id]; const remaining = maxFieldDays - stats.field; const isWarning = remaining <= 5;
                                  return (
                                      <tr key={student.id} onClick={() => setSelectedFtStudent(student.id)} className="border-b border-stone-50 hover:bg-stone-50/80 transition-colors cursor-pointer">
                                          <td className="p-4 pl-6"><span className="font-bold text-stone-800 text-base flex items-center"><span className="text-stone-400 font-medium w-6 text-sm">{student.number}.</span>{student.name}</span></td>
                                          <td className="p-4 text-center"><span className="font-black text-blue-600 text-lg">{stats.field}</span><span className="text-stone-400 text-sm ml-1">ì¼</span></td>
                                          <td className="p-4 text-center"><span className={`font-bold px-3 py-1.5 rounded-xl text-sm ${remaining < 0 ? 'bg-rose-500 text-white shadow-sm' : isWarning ? 'bg-rose-50 text-rose-600 border border-rose-100' : 'bg-stone-100 text-stone-600'}`}>{remaining}ì¼</span></td>
                                          <td className="p-4 text-center text-stone-500 font-medium">{stats.ftCount}íšŒ</td>
                                          <td className="p-4 text-center text-sm text-stone-400 font-medium">{stats.ftRecords.length > 0 ? [...stats.ftRecords].sort((a,b)=>b.startDate.localeCompare(a.startDate))[0].startDate : '-'}</td>
                                      </tr>
                                  );
                              })}
                          </tbody>
                      </table>
                  </div>
                </section>
              </div>
            );
          };

          const renderRosterSetup = () => {
              const handleSaveRoster = () => {
                  const names = rosterInput.split('\n').map(n => n.trim()).filter(n => n !== '');
                  const newStudents = names.map((name, idx) => {
                      const existing = students[idx];
                      return existing ? { ...existing, name, number: idx + 1 } : { id: `s${Date.now()}_${idx}`, number: idx + 1, name };
                  });
                  setStudents(newStudents);
                  alert('ëª…ë ¬í‘œê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ ë° ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
              };

              return (
                  <div className="w-full">
                      <div className="bg-white rounded-3xl shadow-sm border border-stone-100 p-8">
                          <h2 className="text-2xl font-black flex items-center gap-2 text-stone-700 mb-2"><Icon name="list-ordered" className="text-emerald-500" size={28} /><span>ì´ˆê¸° ëª…ë ¬í‘œ ì¼ê´„ ì„¤ì •</span></h2>
                          <p className="text-stone-500 mb-6 font-medium">ìš°ë¦¬ ë°˜ í•™ìƒ ì´ë¦„ì„ ë²ˆí˜¸ìˆœìœ¼ë¡œ <strong className="text-emerald-600">í•œ ì¤„ì— í•œ ëª…ì”©</strong> ì—‘ì…€ì—ì„œ ë³µì‚¬í•´ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. <br/>ì…ë ¥ëœ ìˆœì„œëŒ€ë¡œ ë²ˆí˜¸ê°€ ìë™ ë¶€ì—¬ë˜ë©°, ëª¨ë“  íƒ­(ì¶œê²°, ìƒë‹´ ë“±)ì— ì¦‰ì‹œ ì ìš©ë©ë‹ˆë‹¤.</p>
                          <textarea value={rosterInput} onChange={(e) => setRosterInput(e.target.value)} placeholder="ì˜ˆì‹œ)&#10;ê¹€ì² ìˆ˜&#10;ì´ì˜í¬&#10;ë°•ë¯¼ìˆ˜" className="w-full h-96 p-5 bg-stone-50 border border-stone-100 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-200 transition-all mb-6 resize-none text-base font-bold text-stone-700 shadow-inner"></textarea>
                          <button onClick={handleSaveRoster} className="w-full py-4 bg-emerald-600 text-white font-bold text-lg rounded-2xl hover:bg-emerald-700 active:scale-95 transition-all shadow-sm flex justify-center items-center gap-2"><Icon name="save" size={20} />ëª…ë ¬í‘œ ì €ì¥ ë° ë°˜ì˜</button>
                      </div>
                  </div>
              );
          };

          const renderRoster = () => {
            const handleExport = () => {
              const headers = ['ë²ˆí˜¸', 'ì´ë¦„', 'ê²°ì„', 'ì¡°í‡´', 'ì§€ê°', 'ê²°ê³¼', 'êµì™¸ì²´í—˜'];
              const data = [...students].sort((a,b)=>a.number - b.number).map(s => [
                s.number, s.name, studentStats[s.id].absent, studentStats[s.id].early, studentStats[s.id].late, studentStats[s.id].missed, studentStats[s.id].field
              ]);
              exportToExcel('ì¶œê²°í†µê³„.xlsx', headers, data);
            };

            const updateStudent = (id, field, value) => setStudents(students.map(s => s.id === id ? { ...s, [field]: value } : s));
            const removeStudent = (id) => { if(window.confirm('í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ê¸°ë¡ì€ ìœ ì§€ë˜ë‚˜ ëª…ë‹¨ì—ì„œ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.')) setStudents(students.filter(s => s.id !== id)); };

            return (
              <div className="p-6 bg-white rounded-3xl shadow-sm border border-stone-100">
                <div className="flex justify-between items-start mb-6">
                  <h2 className="text-xl font-bold text-stone-700 flex items-center mt-1"><Icon name="users" size={24} className="mr-2 text-emerald-500"/> ì¶œê²° í†µê³„</h2>
                  <div className="flex flex-col gap-2 items-end">
                    <div className="flex gap-2">
                      <button onClick={handleExport} className="px-3 py-2 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded-xl hover:bg-emerald-100 font-bold transition-colors text-sm flex items-center shadow-sm gap-1.5"><Icon name="download" size={16} /> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                      <button onClick={openGoogleSheets} className="px-3 py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-xl hover:bg-blue-100 font-bold transition-colors text-sm flex items-center shadow-sm gap-1.5"><Icon name="table" size={16} /> ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°</button>
                    </div>
                    <p className="text-[11px] text-stone-400">ë‹¤ìš´ë¡œë“œëœ ì—‘ì…€ì„ êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì˜¬ë¦¬ë©´ ë°”ë¡œ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                  </div>
                </div>
                
                <p className="text-sm text-stone-400 mb-4">* í•™ìƒ í–‰ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ì¶œê²° ê¸°ë¡ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (êµì™¸ì²´í—˜ì€ 'êµì™¸ì²´í—˜ ë§¤ë‹ˆì €' íƒ­ì—ì„œ ê´€ë¦¬ë©ë‹ˆë‹¤.)</p>

                <div className="overflow-x-auto rounded-2xl border border-stone-100">
                  <table className="w-full text-left border-collapse min-w-[800px]">
                    <thead>
                      <tr className="bg-stone-50 border-b border-stone-100 text-stone-500 text-sm">
                        <th className="p-4 w-16 text-center font-bold">ë²ˆí˜¸</th><th className="p-4 font-bold">ì´ë¦„</th><th className="p-4 w-20 text-center text-rose-500 font-bold">ê²°ì„</th><th className="p-4 w-20 text-center text-amber-500 font-bold">ì¡°í‡´</th><th className="p-4 w-20 text-center text-indigo-500 font-bold">ì§€ê°</th><th className="p-4 w-20 text-center text-violet-500 font-bold">ê²°ê³¼</th><th className="p-4 w-24 text-center text-blue-500 font-bold">êµì™¸ì²´í—˜</th><th className="p-4 w-24 text-center font-bold">ê´€ë¦¬</th>
                      </tr>
                    </thead>
                    <tbody>
                      {[...students].sort((a,b)=>a.number - b.number).map(student => (
                        <tr key={student.id} onClick={() => setSelectedStudentForModal(student.id)} className="border-b border-stone-50 hover:bg-stone-50/50 transition-colors cursor-pointer">
                          <td className="p-2 text-center" onClick={e => e.stopPropagation()}><input type="number" value={student.number} onChange={(e) => updateStudent(student.id, 'number', Number(e.target.value))} className="w-12 text-center bg-transparent border-b-2 border-transparent hover:border-stone-300 focus:border-emerald-400 focus:outline-none transition-colors" /></td>
                          <td className="p-2" onClick={e => e.stopPropagation()}><input type="text" value={student.name} placeholder="ì´ë¦„ ì…ë ¥" onChange={(e) => updateStudent(student.id, 'name', e.target.value)} className="w-full bg-transparent border-b-2 border-transparent hover:border-stone-300 focus:border-emerald-400 focus:outline-none px-2 py-1 transition-colors font-bold" /></td>
                          <td className="p-4 text-center bg-rose-50/30 font-bold text-rose-600">{studentStats[student.id]?.absent || 0}</td><td className="p-4 text-center bg-amber-50/30 font-bold text-amber-600">{studentStats[student.id]?.early || 0}</td><td className="p-4 text-center bg-indigo-50/30 font-bold text-indigo-600">{studentStats[student.id]?.late || 0}</td><td className="p-4 text-center bg-violet-50/30 font-bold text-violet-600">{studentStats[student.id]?.missed || 0}</td><td className="p-4 text-center bg-blue-50/30 font-bold text-blue-600">{studentStats[student.id]?.field || 0}</td>
                          <td className="p-4 text-center space-x-3" onClick={e => e.stopPropagation()}>
                            <button onClick={() => setSelectedStudentForModal(student.id)} className="text-stone-300 hover:text-emerald-500 transition-colors"><Icon name="search" size={18} /></button>
                            <button onClick={() => removeStudent(student.id)} className="text-stone-300 hover:text-rose-400 transition-colors"><Icon name="trash-2" size={18} /></button>
                          </td>
                        </tr>
                      ))}
                      {students.length === 0 && (<tr><td colSpan="8" className="text-center p-10 text-stone-400 font-medium">ì•„ë˜ 'ëª…ë ¬í‘œ ì¼ê´„ ì„¤ì •'ì„ í†µí•´ í•™ìƒì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</td></tr>)}
                    </tbody>
                  </table>
                </div>
              </div>
            );
          };

          const renderCounseling = () => {
            const handleExport = () => {
              const headers = ['ì¼ì‹œ', 'í•™ìƒëª…', 'ìƒë‹´ë‚´ìš©'];
              const data = counseling.map(c => {
                const student = students.find(s => s.id === c.studentId);
                return [c.date, student ? student.name : 'ì•Œìˆ˜ì—†ìŒ', c.content];
              });
              exportToExcel('ìƒë‹´ì¼ì§€.xlsx', headers, data);
            };
            const deleteCounseling = (id) => { if(window.confirm('ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) setCounseling(counseling.filter(c => c.id !== id)); };
            const sortedCounseling = [...counseling].sort((a,b) => new Date(b.date) - new Date(a.date));

            return (
              <div className="p-6 bg-white rounded-3xl shadow-sm border border-stone-100">
                <div className="flex justify-between items-start mb-6">
                  <h2 className="text-xl font-bold text-stone-700 flex items-center mt-1"><Icon name="book-open" size={24} className="mr-2 text-emerald-500"/> í•™ìƒ ìƒë‹´ ì¼ì§€</h2>
                  <div className="flex flex-col gap-2 items-end">
                    <div className="flex gap-2">
                      <button onClick={handleExport} className="px-3 py-2 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded-xl hover:bg-emerald-100 font-bold transition-colors text-sm flex items-center shadow-sm gap-1.5"><Icon name="download" size={16} /> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                      <button onClick={openGoogleSheets} className="px-3 py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-xl hover:bg-blue-100 font-bold transition-colors text-sm flex items-center shadow-sm gap-1.5"><Icon name="table" size={16} /> ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°</button>
                    </div>
                  </div>
                </div>

                <div className="grid gap-4">
                  {sortedCounseling.length === 0 ? (
                    <div className="text-center p-12 text-stone-400 border border-dashed border-stone-200 rounded-2xl bg-stone-50/50 font-medium">ë‹¬ë ¥ì˜ ê° ë‚ ì§œ ì¹¸ì„ í´ë¦­í•˜ì—¬ ìƒë‹´ ë‚´ìš©ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                  ) : (
                    sortedCounseling.map(record => {
                      const student = students.find(s => s.id === record.studentId);
                      return (
                        <div key={record.id} className="border border-stone-100 p-5 rounded-2xl hover:shadow-md transition-shadow bg-white">
                          <div className="flex justify-between items-center mb-3">
                            <div className="flex items-center gap-3"><span className="bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-lg text-sm font-bold">{record.date}</span><span className="font-extrabold text-lg text-stone-700">{student ? student.name : 'ì‚­ì œëœ í•™ìƒ'}</span></div>
                            <button onClick={() => deleteCounseling(record.id)} className="text-stone-300 hover:text-rose-400 transition-colors p-2"><Icon name="trash-2" size={18}/></button>
                          </div>
                          <p className="text-stone-600 whitespace-pre-wrap leading-relaxed">{record.content}</p>
                        </div>
                      );
                    })
                  )}
                </div>
              </div>
            );
          };

          const renderTimetable = () => {
            const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
            const updateSubject = (dayIndex, periodIndex, val) => {
              setTimetable(prev => { const newTable = { ...prev }; newTable[dayIndex] = [...prev[dayIndex]]; newTable[dayIndex][periodIndex] = val; return newTable; });
            };
            return (
              <div className="p-6 bg-white rounded-3xl shadow-sm border border-stone-100">
                <h2 className="text-xl font-bold text-stone-700 flex items-center mb-6"><Icon name="clock" size={24} className="mr-2 text-emerald-500"/> ê¸°ì´ˆì‹œê°„í‘œ ì„¤ì •</h2>
                <div className="overflow-x-auto rounded-2xl border border-stone-100">
                  <table className="w-full text-center border-collapse">
                    <thead><tr className="bg-stone-50 border-b border-stone-100"><th className="p-4 w-16 border-r border-stone-100 text-stone-500 font-bold">êµì‹œ</th>{days.map(day => <th key={day} className="p-4 font-bold text-stone-600">{day}</th>)}</tr></thead>
                    <tbody>
                      {Array(8).fill(0).map((_, periodIndex) => (
                        <tr key={periodIndex} className="border-b border-stone-50">
                          <td className="p-4 border-r border-stone-100 bg-stone-50/50 font-extrabold text-stone-400">{periodIndex + 1}</td>
                          {[1, 2, 3, 4, 5].map(dayIndex => (
                            <td key={dayIndex} className="p-2"><input type="text" value={timetable[dayIndex][periodIndex]} onChange={(e) => updateSubject(dayIndex, periodIndex, e.target.value)} className="w-full text-center p-2.5 rounded-xl hover:bg-stone-50 focus:bg-emerald-50 focus:outline-none transition-colors font-bold text-stone-700" placeholder="-"/></td>
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            );
          };

          const renderEvaluation = () => {
            const updateEval = (id, field, val) => setEvaluations(evaluations.map(e => e.id === id ? { ...e, [field]: val } : e));
            const deleteEval = (id) => { if(window.confirm('í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) setEvaluations(evaluations.filter(e => e.id !== id)); }

            const handleDownloadTemplate = () => {
                const headers = ['ê³¼ëª©', 'ë‹¨ì›', 'í‰ê°€ ìš”ì†Œ', 'ì˜ì—­', 'ì‹œê¸°', 'ë°©ë²•'];
                const data = [['êµ­ì–´', '1. ë¹„êµí•˜ë©° ì½ì–´ìš”', 'ì´ì•¼ê¸°ì˜ ì„¸ê³„ì™€ \ní˜„ì‹¤ ì„¸ê³„ë¥¼ ë¹„êµ\ní•˜ë©° ì‘í’ˆ ê°ìƒí•˜ê¸°', 'ë¬¸í•™', '3ì›”', 'ì„œìˆ  ë…¼ìˆ  í‰ê°€']];
                exportToExcel('í‰ê°€ê³„íš_ì—…ë¡œë“œì–‘ì‹.xlsx', headers, data);
            };

            const getMonth = (periodStr) => {
                if (typeof periodStr !== 'string') return 0;
                const match = periodStr.match(/([1-9]|1[0-2])ì›”/);
                return match ? parseInt(match[1], 10) : 0;
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const ws = XLSX.read(evt.target.result, { type: 'binary' }).Sheets[XLSX.read(evt.target.result, { type: 'binary' }).SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(ws);
                    const newEvals = data.map((row, idx) => {
                        const period = String(row['ì‹œê¸°'] || '').trim(); const month = getMonth(period);
                        const semester = (month >= 3 && month <= 7) ? '1í•™ê¸°' : (month > 0 ? '2í•™ê¸°' : '1í•™ê¸°');
                        const isDone = ['ì‹¤ì‹œ', 'ì™„ë£Œ', 'o', 'O', 'y', 'Y', 'true', 'TRUE', 'ì‹¤ì‹œì™„ë£Œ'].includes(String(row['ì‹¤ì‹œì—¬ë¶€'] || row['ì™„ë£Œì—¬ë¶€'] || row['ì™„ë£Œ ì—¬ë¶€'] || '').trim());
                        return { id: Date.now() + idx, isDone, subject: row['ê³¼ëª©'] || '', unit: row['ë‹¨ì›ëª…'] || row['ë‹¨ì›'] || '', element: row['í‰ê°€ìš”ì†Œ'] || row['í‰ê°€ ìš”ì†Œ'] || '', domain: row['ì˜ì—­'] || '', period, method: row['ë°©ë²•'] || '', semester };
                    });
                    setEvaluations(prev => [...prev, ...newEvals]);
                    e.target.value = '';
                };
                reader.readAsBinaryString(file);
            };

            const renderTable = (semester, months) => {
                const semEvals = evaluations.filter(ev => (ev.semester || '1í•™ê¸°') === semester);
                return (
                  <div className="mb-10">
                    <h3 className="text-xl font-extrabold text-stone-700 flex items-center mb-4"><Icon name="bookmark" size={24} className="mr-2 text-emerald-500"/>{semester} í‰ê°€ê³„íš</h3>
                    <div className="overflow-x-auto rounded-2xl border border-stone-100 bg-white shadow-sm">
                      <table className="w-full text-left border-collapse min-w-[1200px]">
                        <thead><tr className="bg-stone-50 border-b border-stone-100 text-sm text-stone-500"><th className="p-3 w-20 text-center font-bold">ì‹¤ì‹œ</th><th className="p-3 w-28 font-bold">ê³¼ëª©</th><th className="p-3 w-40 font-bold">ë‹¨ì›</th><th className="p-3 font-bold">í‰ê°€ ìš”ì†Œ</th><th className="p-3 w-28 font-bold">ì˜ì—­</th><th className="p-3 w-28 font-bold text-center">ì‹œê¸°</th><th className="p-3 w-32 font-bold">ë°©ë²•</th><th className="p-3 w-16 text-center font-bold">ì‚­ì œ</th></tr></thead>
                        <tbody>
                          {months.map(m => {
                              const mEvals = semEvals.filter(ev => getMonth(ev.period) === m);
                              if (m === 0 && mEvals.length === 0) return null;
                              if (m !== 0 && mEvals.length === 0 && semEvals.length === 0) return null;

                              return (
                                  <React.Fragment key={`${semester}-${m}`}>
                                      <tr className="bg-emerald-50/60 border-y border-emerald-100"><td colSpan="8" className="p-3 font-extrabold text-emerald-800 text-base"><Icon name="calendar" size={16} className="inline-block mr-2 -mt-0.5 text-emerald-600"/>{m === 0 ? 'ì‹œê¸° ë¯¸ì§€ì • (ë˜ëŠ” ê¸°íƒ€)' : `${m}ì›” í‰ê°€ê³„íš`}</td></tr>
                                      {mEvals.length === 0 ? (<tr><td colSpan="8" className="p-4 text-center text-stone-400 text-sm font-medium bg-white">ê³„íšëœ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>) : (
                                          mEvals.map(ev => (
                                              <tr key={ev.id} className={`border-b transition-colors ${ev.isDone ? 'bg-emerald-50/60 border-emerald-200' : 'bg-white border-stone-50 hover:bg-stone-50/50'}`}>
                                                  <td className="p-2 text-center bg-emerald-50/20"><label className="flex flex-col items-center justify-center cursor-pointer p-1"><input type="checkbox" checked={!!ev.isDone} onChange={(e) => updateEval(ev.id, 'isDone', e.target.checked)} className="w-5 h-5 accent-emerald-500 cursor-pointer rounded mb-1"/><span className={`text-[11px] font-bold mt-1 ${ev.isDone ? 'text-emerald-600' : 'text-stone-400'}`}>{ev.isDone ? 'ì‹¤ì‹œì™„ë£Œ' : 'ë¯¸ì‹¤ì‹œ'}</span></label></td>
                                                  <td className="p-2"><input type="text" value={ev.subject || ''} onChange={(e) => updateEval(ev.id, 'subject', e.target.value)} className="w-full bg-transparent p-2 border-b-2 border-transparent focus:border-emerald-400 outline-none font-medium text-stone-600 rounded-lg"/></td>
                                                  <td className="p-2"><input type="text" value={ev.unit || ''} onChange={(e) => updateEval(ev.id, 'unit', e.target.value)} className="w-full bg-transparent p-2 border-b-2 border-transparent focus:border-emerald-400 outline-none font-medium text-stone-600 rounded-lg"/></td>
                                                  <td className="p-2"><input type="text" value={ev.element || ''} onChange={(e) => updateEval(ev.id, 'element', e.target.value)} className="w-full bg-transparent p-2 border-b-2 border-transparent focus:border-emerald-400 outline-none font-medium text-stone-600 rounded-lg"/></td>
                                                  <td className="p-2"><input type="text" value={ev.domain || ''} onChange={(e) => updateEval(ev.id, 'domain', e.target.value)} className="w-full bg-transparent p-2 border-b-2 border-transparent focus:border-emerald-400 outline-none font-medium text-stone-600 rounded-lg"/></td>
                                                  <td className="p-2"><input type="text" value={ev.period || ''} onChange={(e) => updateEval(ev.id, 'period', e.target.value)} className="w-full text-center bg-transparent p-2 border-b-2 border-transparent focus:border-emerald-400 outline-none font-medium text-stone-600 rounded-lg"/></td>
                                                  <td className="p-2"><input type="text" value={ev.method || ''} onChange={(e) => updateEval(ev.id, 'method', e.target.value)} className="w-full bg-transparent p-2 border-b-2 border-transparent focus:border-emerald-400 outline-none font-medium text-stone-600 rounded-lg"/></td>
                                                  <td className="p-2 text-center"><button onClick={() => deleteEval(ev.id)} className="p-2 text-stone-300 hover:text-rose-400 transition-colors rounded-lg"><Icon name="trash-2" size={18}/></button></td>
                                              </tr>
                                          ))
                                      )}
                                  </React.Fragment>
                              );
                          })}
                          {semEvals.length === 0 && <tr><td colSpan="8" className="p-12 text-center text-stone-400 font-medium bg-stone-50/30">ë“±ë¡ëœ {semester} í‰ê°€ê³„íšì´ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ 'ì—‘ì…€ ì—…ë¡œë“œ'ë¥¼ ì´ìš©í•´ ì£¼ì„¸ìš”.</td></tr>}
                        </tbody>
                      </table>
                    </div>
                  </div>
                );
            };

            return (
              <div className="p-6 bg-white rounded-3xl shadow-sm border border-stone-100">
                <div className="flex justify-between items-center mb-8">
                  <h2 className="text-xl font-bold text-stone-700 flex items-center"><Icon name="file-text" size={24} className="mr-2 text-emerald-500"/> í•™ê¸°ë³„ í‰ê°€ê³„íš</h2>
                  <div className="flex items-center gap-2">
                    <button onClick={handleDownloadTemplate} className="px-4 py-2 bg-white text-emerald-600 border border-emerald-200 rounded-xl hover:bg-emerald-50 font-bold transition-colors text-sm flex items-center shadow-sm gap-1.5"><Icon name="download-cloud" size={16} /> ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
                    <input type="file" accept=".xlsx, .xls, .csv" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                    <button onClick={() => fileInputRef.current.click()} className="px-4 py-2 bg-emerald-50 text-emerald-700 border border-emerald-200 rounded-xl hover:bg-emerald-100 font-bold transition-colors text-sm flex items-center shadow-sm gap-1.5"><Icon name="upload" size={16} /> ì—‘ì…€ ì—…ë¡œë“œ</button>
                    <button onClick={() => setEvaluations([...evaluations, { id: Date.now(), semester: '1í•™ê¸°', isDone: false, subject: '', unit: '', element: '', domain: '', period: '', method: '' }])} className="px-4 py-2 bg-emerald-600 text-white rounded-xl font-bold text-sm shadow-sm transition-all active:scale-95 ml-2">í•­ëª© ì¶”ê°€</button>
                  </div>
                </div>
                {renderTable('1í•™ê¸°', [3, 4, 5, 6, 7, 0])}
                {renderTable('2í•™ê¸°', [8, 9, 10, 11, 12, 1, 2, 0])}
              </div>
            );
          };

          const renderDailyModal = () => {
            if (!selectedDate) return null;
            
            const dayOfWeek = new Date(selectedDate).getDay(); const isWeekday = dayOfWeek >= 1 && dayOfWeek <= 5;
            const todayHoliday = holidays[selectedDate]; const todayEvent = customEvents[selectedDate];
            const isOffDay = todayHoliday || (todayEvent && (todayEvent.includes('ë°©í•™') || todayEvent.includes('íœ´ì—…') || todayEvent.includes('ì¬ëŸ‰')));
            const showTimetable = isWeekday && !isOffDay;

            const dayAttendance = attendance[selectedDate] || [];
            const dayFieldTrips = fieldTrips.filter(ft => selectedDate >= ft.startDate && selectedDate <= ft.endDate);
            const dayTodos = todos[selectedDate] || [];
            const dayCounseling = counseling.filter(c => c.date === selectedDate);
            const selectedMonth = parseInt(selectedDate.split('-')[1], 10);
            const monthEvals = evaluations.filter(ev => { if (typeof ev.period !== 'string') return false; const match = ev.period.match(/([1-9]|1[0-2])ì›”/); return match && parseInt(match[1], 10) === selectedMonth; });

            const draft = dmDrafts[selectedDate] || { attStudent: '', attType: 'ê²°ì„', attSubType: 'ì§ˆë³‘', attPeriod: '', attDocType: 'none', todoText: '', counselStudent: '', counselText: '' };
            const updateDraft = (field, value) => setDmDrafts(prev => ({ ...prev, [selectedDate]: { ...(prev[selectedDate] || { attStudent: '', attType: 'ê²°ì„', attSubType: 'ì§ˆë³‘', attPeriod: '', attDocType: 'none', todoText: '', counselStudent: '', counselText: '' }), [field]: value } }));

            const handleAddAttendance = () => {
              if (!draft.attStudent) return alert('í•™ìƒì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
              const needsSubType = ['ê²°ì„', 'ì¡°í‡´', 'ì§€ê°', 'ê²°ê³¼'].includes(draft.attType);
              const newRecord = { id: Date.now(), studentId: draft.attStudent, type: draft.attType, subType: needsSubType ? draft.attSubType : null, period: draft.attPeriod !== '' ? draft.attPeriod : null, docType: draft.attDocType };
              setAttendance(prev => ({ ...prev, [selectedDate]: [...(prev[selectedDate] || []), newRecord] }));
              updateDraft('attDocType', 'none'); updateDraft('attPeriod', '');
            };
            const handleDelAttendance = (id) => setAttendance(prev => ({ ...prev, [selectedDate]: prev[selectedDate].filter(r => r.id !== id) }));

            const handleAddTodo = (e) => { e.preventDefault(); if (!draft.todoText.trim()) return; const newTodo = { id: Date.now(), text: draft.todoText, done: false }; setTodos(prev => ({ ...prev, [selectedDate]: [...(prev[selectedDate] || []), newTodo] })); updateDraft('todoText', ''); };
            const toggleTodo = (id) => setTodos(prev => ({ ...prev, [selectedDate]: prev[selectedDate].map(t => t.id === id ? { ...t, done: !t.done } : t) }));
            const deleteTodo = (id) => setTodos(prev => ({ ...prev, [selectedDate]: prev[selectedDate].filter(t => t.id !== id) }));

            const handleAddCounseling = () => {
              if (!draft.counselStudent) return alert('í•™ìƒì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
              if (!draft.counselText.trim()) return alert('ìƒë‹´ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
              setCounseling(prev => [...prev, { id: Date.now(), date: selectedDate, studentId: draft.counselStudent, content: draft.counselText }]);
              updateDraft('counselText', '');
            };

            const saveMemo = () => setMemos(prev => ({ ...prev, [selectedDate]: dmMemoText }));
            const handleCloseModal = () => { saveMemo(); setDmShowMonthEval(false); setIsEditingLink(false); setSelectedDate(null); };

            return (
              <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={handleCloseModal}>
                <div className="bg-[#fdfbf7] rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl flex flex-col" onClick={e => e.stopPropagation()}>
                  <div className="sticky top-0 bg-[#fdfbf7] border-b border-stone-200 px-6 py-5 flex justify-between items-center z-10 rounded-t-3xl">
                    <h3 className="text-2xl font-extrabold text-stone-700 flex items-center gap-2 flex-wrap">
                      {selectedDate} <span className="text-sm font-bold text-stone-400 bg-stone-100 px-3 py-1.5 rounded-xl">{['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][dayOfWeek]}ìš”ì¼</span>
                      {todayHoliday && <span className="text-sm font-bold text-rose-500 bg-rose-50 px-3 py-1.5 rounded-xl border border-rose-100">{todayHoliday}</span>}
                      {todayEvent && <span className="text-sm font-bold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-xl border border-emerald-100">{todayEvent}</span>}
                    </h3>
                    <button onClick={handleCloseModal} className="p-2 hover:bg-stone-200 rounded-full transition-colors text-stone-500"><Icon name="x" size={24}/></button>
                  </div>

                  <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="space-y-6">
                      <div className="bg-emerald-50/50 p-5 rounded-3xl border border-emerald-100/50">
                        <h4 className="font-bold text-emerald-800 mb-4 flex items-center"><Icon name="clock" size={18} className="mr-2"/> ë‹¹ì¼ ì‹œê°„í‘œ</h4>
                        {showTimetable ? (
                          <div className="grid grid-cols-4 gap-3">
                            {timetable[dayOfWeek].map((subj, idx) => (
                              <div key={idx} className="bg-white p-3 rounded-2xl shadow-sm text-center border border-stone-50 flex flex-col">
                                <span className="text-[11px] font-bold text-stone-400 mb-1">{idx+1}êµì‹œ</span>
                                <span className="font-bold text-stone-600 truncate">{subj || '-'}</span>
                              </div>
                            ))}
                          </div>
                        ) : <div className="text-sm text-stone-400 bg-white p-4 rounded-2xl text-center border border-stone-100 font-medium">{todayHoliday ? `íœ´ì—…ì¼(${todayHoliday})ì€ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.` : isOffDay ? `íœ´ì—…ì¼(${todayEvent})ì€ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.` : 'ì£¼ë§ì€ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.'}</div>}
                      </div>

                      <div className="bg-emerald-50/30 p-5 rounded-3xl border border-emerald-100/30">
                        <h4 className="font-bold text-emerald-700 mb-4 flex items-center"><Icon name="check" size={18} className="mr-2"/> ì˜¤ëŠ˜ í•´ì•¼ í•  ì¼</h4>
                        <form onSubmit={handleAddTodo} className="flex gap-2 mb-4">
                          <input type="text" value={draft.todoText} onChange={e=>updateDraft('todoText', e.target.value)} placeholder="í¸ì•ˆí•œ ë§ˆìŒìœ¼ë¡œ í•  ì¼ì„ ì ì–´ë³´ì„¸ìš”..." className="flex-1 p-3 border-none bg-white rounded-xl shadow-sm text-sm outline-none focus:ring-2 focus:ring-emerald-200 transition-shadow"/>
                          <button type="submit" className="bg-emerald-500 text-white p-3 rounded-xl hover:bg-emerald-600 shadow-sm transition-colors"><Icon name="plus" size={20}/></button>
                        </form>
                        <div className="space-y-3 max-h-40 overflow-y-auto pr-1">
                          {dayTodos.map(todo => (
                            <div key={todo.id} className="flex items-center justify-between bg-white p-3 rounded-2xl shadow-sm border border-stone-50">
                              <div className="flex items-center gap-3 cursor-pointer flex-1" onClick={() => toggleTodo(todo.id)}>
                                <div className={`w-5 h-5 rounded-full flex items-center justify-center transition-colors ${todo.done ? 'bg-emerald-400 text-white' : 'border-2 border-stone-200'}`}>{todo.done && <Icon name="check" size={14} strokeWidth={3}/>}</div>
                                <span className={`text-sm font-medium ${todo.done ? 'line-through text-stone-300' : 'text-stone-600'}`}>{todo.text}</span>
                              </div>
                              <button onClick={()=>deleteTodo(todo.id)} className="text-stone-300 hover:text-rose-400 p-1 transition-colors"><Icon name="x" size={18}/></button>
                            </div>
                          ))}
                        </div>
                      </div>

                      <div className="bg-amber-50/30 p-5 rounded-3xl border border-amber-100/30">
                        <h4 className="font-bold text-amber-800 mb-4 flex items-center"><Icon name="edit-2" size={18} className="mr-2"/> ì¼ì¼ ë©”ëª¨</h4>
                        <textarea value={dmMemoText} onChange={e=>setDmMemoText(e.target.value)} onBlur={saveMemo} placeholder="ì˜¤ëŠ˜ í•˜ë£¨ ìˆì—ˆë˜ ì¼ì´ë‚˜ ìŠì§€ ë§ì•„ì•¼ í•  ë©”ëª¨ë¥¼ í¸ì•ˆí•˜ê²Œ ì ì–´ë³´ì„¸ìš”." className="w-full p-4 border-none bg-white rounded-2xl shadow-sm text-sm outline-none resize-none h-24 focus:ring-2 focus:ring-amber-200 transition-shadow leading-relaxed" />
                      </div>
                    </div>

                    <div className="space-y-6">
                      <div className="bg-rose-50/30 p-5 rounded-3xl border border-rose-100/30">
                        <h4 className="font-bold text-rose-800 mb-4 flex items-center"><Icon name="users" size={18} className="mr-2"/> í•™ìƒ ì¶œê²°</h4>
                        <div className="flex flex-wrap gap-2 mb-4 items-center">
                          <select value={draft.attStudent} onChange={e=>updateDraft('attStudent', e.target.value)} className="flex-1 min-w-[100px] p-3 border-none bg-white rounded-xl shadow-sm text-sm outline-none font-medium text-stone-600">
                            <option value="">í•™ìƒ ì„ íƒ</option>
                            {[...students].sort((a,b)=>a.number - b.number).map(s => <option key={s.id} value={s.id}>{s.number}ë²ˆ {s.name}</option>)}
                          </select>
                          <select value={draft.attType} onChange={e=>updateDraft('attType', e.target.value)} className="w-24 p-3 border-none bg-white rounded-xl shadow-sm text-sm outline-none font-medium text-stone-600">
                            <option value="ê²°ì„">ê²°ì„</option><option value="ì¡°í‡´">ì¡°í‡´</option><option value="ì§€ê°">ì§€ê°</option><option value="ê²°ê³¼">ê²°ê³¼</option>
                          </select>
                          {['ê²°ì„', 'ì¡°í‡´', 'ì§€ê°', 'ê²°ê³¼'].includes(draft.attType) && (
                            <select value={draft.attSubType} onChange={e=>updateDraft('attSubType', e.target.value)} className="w-20 p-3 border-none bg-white rounded-xl shadow-sm text-sm outline-none font-medium text-stone-600">
                              {ATTENDANCE_SUB_TYPES.map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                          )}
                          <select value={draft.attPeriod} onChange={e=>updateDraft('attPeriod', e.target.value)} className="w-24 p-3 border-none bg-white rounded-xl shadow-sm text-sm outline-none font-medium text-stone-600">
                            <option value="">ì¢…ì¼/ì „ì²´</option>{[1,2,3,4,5,6,7,8].map(p => <option key={p} value={p}>{p}êµì‹œ</option>)}
                          </select>
                          <div className="flex items-center gap-3 bg-white px-3 h-12 rounded-xl shadow-sm border border-transparent">
                            <label className="flex items-center gap-1.5 cursor-pointer"><input type="radio" name="docType" value="none" checked={draft.attDocType === 'none'} onChange={e => updateDraft('attDocType', e.target.value)} className="w-4 h-4 accent-emerald-500 cursor-pointer" /><span className="text-[13px] font-bold text-stone-600">ì—†ìŒ</span></label>
                            <label className="flex items-center gap-1.5 cursor-pointer"><input type="radio" name="docType" value="paper" checked={draft.attDocType === 'paper'} onChange={e => updateDraft('attDocType', e.target.value)} className="w-4 h-4 accent-emerald-500 cursor-pointer" /><span className="text-[13px] font-bold text-stone-600">ì„œë¥˜</span></label>
                            <label className="flex items-center gap-1.5 cursor-pointer"><input type="radio" name="docType" value="neis" checked={draft.attDocType === 'neis'} onChange={e => updateDraft('attDocType', e.target.value)} className="w-4 h-4 accent-emerald-500 cursor-pointer" /><span className="text-[13px] font-bold text-stone-600">NEIS</span></label>
                          </div>
                          <button onClick={handleAddAttendance} className="bg-rose-400 text-white p-3 rounded-xl hover:bg-rose-500 shadow-sm transition-colors flex items-center justify-center"><Icon name="plus" size={20}/></button>
                        </div>
                        
                        <div className="space-y-2 max-h-32 overflow-y-auto pr-1">
                          {dayAttendance.map(att => {
                            const st = students.find(s=>s.id === att.studentId);
                            const isPaper = att.docType === 'paper' || att.docSubmitted; const isNeis = att.docType === 'neis';
                            return (
                              <div key={att.id} className="flex justify-between items-center bg-white p-3 rounded-2xl border border-stone-50 shadow-sm text-sm">
                                <div className="flex items-center gap-2 flex-wrap">
                                  <span className="font-extrabold text-stone-600">{st?.name}</span> <span className="text-stone-300">|</span> 
                                  <span className={`font-bold ${att.type==='ê²°ì„'?'text-rose-500':att.type==='ì¡°í‡´'?'text-amber-500':att.type==='ì§€ê°'?'text-indigo-500':att.type==='ê²°ê³¼'?'text-violet-500':'text-sky-500'}`}>{att.type}{att.subType ? `(${att.subType})` : ''} {att.period ? `${att.period}êµì‹œ` : ''}</span>
                                  {isPaper && (<span className="flex items-center gap-1 ml-1 px-1.5 py-0.5 bg-emerald-50 text-emerald-600 text-[11px] font-extrabold rounded-md border border-emerald-100"><Icon name="file-check" size={12} /> ì„œë¥˜</span>)}
                                  {isNeis && (<span className="flex items-center gap-1 ml-1 px-1.5 py-0.5 bg-blue-50 text-blue-600 text-[11px] font-extrabold rounded-md border border-blue-100"><Icon name="monitor" size={12} /> NEIS</span>)}
                                </div>
                                <button onClick={()=>handleDelAttendance(att.id)} className="text-stone-300 hover:text-rose-400 p-1 transition-colors"><Icon name="trash-2" size={16}/></button>
                              </div>
                            )
                          })}
                        </div>
                        
                        {!isEditingLink ? (
                            <div className="mt-4 flex items-center gap-2">
                                <a href={docLink || '#'} target="_blank" rel="noopener noreferrer" className="flex-1 flex items-center justify-between p-3.5 bg-white/80 hover:bg-white rounded-2xl shadow-sm border border-rose-100 hover:border-rose-300 transition-all text-sm font-bold text-stone-700 group">
                                    <span className="flex items-center gap-2"><Icon name="external-link" size={18} className="text-rose-500"/> ì¶œê²° ì œì¶œ ì„œë¥˜ ì•ˆë‚´ ë° ë‹¤ìš´ë¡œë“œ</span><Icon name="chevron-right" size={18} className="text-stone-400 group-hover:text-rose-500 transition-colors"/>
                                </a>
                                <button onClick={() => { setTempLink(docLink); setIsEditingLink(true); }} className="p-3.5 bg-white/80 hover:bg-white rounded-2xl shadow-sm border border-stone-100 hover:border-emerald-200 transition-all text-stone-400 hover:text-emerald-500" title="ë§í¬ ì£¼ì†Œ ë³€ê²½"><Icon name="settings" size={18} /></button>
                            </div>
                        ) : (
                            <div className="mt-4 flex items-center gap-2 p-2 bg-white rounded-2xl shadow-sm border border-emerald-300 transition-all">
                                <Icon name="link" size={18} className="text-emerald-500 ml-2" />
                                <input type="text" value={tempLink} onChange={(e) => setTempLink(e.target.value)} placeholder="ì—°ê²°í•  ì›¹ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”" className="flex-1 p-1.5 bg-transparent outline-none text-sm text-stone-600 font-medium" />
                                <button onClick={() => { setDocLink(tempLink); setIsEditingLink(false); }} className="px-3 py-1.5 bg-emerald-500 text-white rounded-xl font-bold text-sm hover:bg-emerald-600 transition-colors">ì €ì¥</button>
                                <button onClick={() => setIsEditingLink(false)} className="px-3 py-1.5 bg-stone-100 text-stone-500 rounded-xl font-bold text-sm hover:bg-stone-200 transition-colors">ì·¨ì†Œ</button>
                            </div>
                        )}
                      </div>

                      <div className="bg-blue-50/30 p-5 rounded-3xl border border-blue-100/30">
                        <div className="flex justify-between items-center mb-4"><h4 className="font-bold text-blue-800 flex items-center"><Icon name="bus" size={18} className="mr-2"/> ë‹¹ì¼ êµì™¸ì²´í—˜í•™ìŠµ ìƒí™©</h4><span className="text-[11px] text-blue-400 font-bold bg-blue-50 px-2 py-0.5 rounded-lg border border-blue-100">ë§¤ë‹ˆì € ì—°ë™</span></div>
                        <div className="space-y-2 max-h-32 overflow-y-auto pr-1">
                          {dayFieldTrips.length === 0 ? (<div className="text-sm text-stone-400 text-center py-4 font-medium bg-white/50 rounded-2xl">ë‹¹ì¼ ì²´í—˜í•™ìŠµ ì—†ìŒ.</div>) : (
                            dayFieldTrips.map(ft => {
                              const st = students.find(s=>s.id === ft.studentId);
                              return (<div key={ft.id} className="flex justify-between items-center bg-white p-3 rounded-2xl border border-stone-50 shadow-sm text-sm"><div className="font-extrabold text-stone-600 flex items-center gap-2">{st?.number}ë²ˆ {st?.name} <span className="text-[11px] px-2 py-0.5 bg-blue-50 text-blue-600 rounded-md">êµì™¸ì²´í—˜ ({ft.duration}ì¼)</span></div></div>)
                            })
                          )}
                        </div>
                      </div>

                      <div className="bg-sky-50/30 p-5 rounded-3xl border border-sky-100/30">
                        <h4 className="font-bold text-sky-800 mb-4 flex items-center"><Icon name="book-open" size={18} className="mr-2"/> ë‹¹ì¼ ìƒë‹´ ê¸°ë¡</h4>
                        <div className="space-y-3 mb-4">
                          <select value={draft.counselStudent} onChange={e=>updateDraft('counselStudent', e.target.value)} className="w-full p-3 border-none bg-white rounded-xl shadow-sm text-sm outline-none font-medium text-stone-600">
                            <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                            {[...students].sort((a,b)=>a.number - b.number).map(s => <option key={s.id} value={s.id}>{s.number}ë²ˆ {s.name}</option>)}
                          </select>
                          <textarea value={draft.counselText} onChange={e=>updateDraft('counselText', e.target.value)} placeholder="ì•„ì´ì˜ ì´ì•¼ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”..." className="w-full p-3 border-none bg-white rounded-xl shadow-sm text-sm outline-none resize-none h-20 focus:ring-2 focus:ring-sky-200 transition-shadow" />
                          <button onClick={handleAddCounseling} className="w-full bg-sky-400 text-white py-3 rounded-xl hover:bg-sky-500 font-bold text-sm shadow-sm transition-colors">ìƒë‹´ ê¸°ë¡ ì €ì¥</button>
                        </div>
                        <div className="space-y-3 max-h-32 overflow-y-auto pr-1">
                          {dayCounseling.map(c => {
                            const st = students.find(s=>s.id === c.studentId);
                            return (<div key={c.id} className="bg-white p-3.5 rounded-2xl border border-stone-50 shadow-sm text-sm"><div className="font-bold text-sky-700 mb-1">{st?.name}</div><p className="text-stone-500 truncate leading-relaxed">{c.content}</p></div>)
                          })}
                        </div>
                      </div>
                    </div>
                    
                    <div className="col-span-1 md:col-span-2 mt-2 bg-indigo-50/40 p-5 rounded-3xl border border-indigo-100/50">
                        <button onClick={() => setDmShowMonthEval(!dmShowMonthEval)} className="w-full flex justify-between items-center font-black text-indigo-800 focus:outline-none">
                            <span className="flex items-center text-lg"><Icon name="file-text" size={20} className="mr-2 text-indigo-600"/> ì´ ë‹¬ì˜ í‰ê°€ê³„íš ({selectedMonth}ì›”)</span>
                            <div className="flex items-center gap-2"><span className="text-sm bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-xl font-bold">{monthEvals.length}ê±´ ì˜ˆì •</span><Icon name={dmShowMonthEval ? "chevron-up" : "chevron-down"} size={20} className="text-indigo-400"/></div>
                        </button>
                        {dmShowMonthEval && (
                            <div className="mt-5 space-y-3">
                                {monthEvals.length === 0 ? (<div className="text-sm text-stone-400 text-center py-6 font-medium bg-white/70 rounded-2xl border border-dashed border-indigo-100">ì´ë²ˆ ë‹¬({selectedMonth}ì›”)ì— ê³„íšëœ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {monthEvals.map(ev => (
                                            <div key={ev.id} className="bg-white p-5 rounded-2xl border border-stone-100 shadow-sm hover:border-indigo-200 transition-colors">
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="font-extrabold text-indigo-700 text-base flex items-center gap-2">{ev.subject || 'ê³¼ëª©ë¯¸ì§€ì •'} <span className="bg-stone-100 text-stone-500 font-bold text-xs px-2 py-0.5 rounded-md">{ev.period}</span></div>
                                                    <span className={`text-xs px-2.5 py-1 rounded-lg font-bold ${ev.isDone ? 'bg-emerald-50 text-emerald-600 border border-emerald-100' : 'bg-rose-50 text-rose-500 border border-rose-100'}`}>{ev.isDone ? 'ì™„ë£Œë¨' : 'ì§„í–‰ ì˜ˆì •'}</span>
                                                </div>
                                                <div className="font-bold text-stone-700 mb-1.5 text-sm">{ev.unit || '-'}</div><div className="text-stone-500 text-sm leading-relaxed">{ev.element || ev.content || '-'}</div>
                                                <div className="mt-3 flex gap-2 pt-3 border-t border-stone-50"><span className="text-xs font-bold text-stone-400 bg-stone-50 px-2 py-1 rounded-md">ë°©ë²•: {ev.tool || ev.method || '-'}</span></div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          const renderStudentDetailModal = () => {
            if (!selectedStudentForModal) return null;
            const student = students.find(s => s.id === selectedStudentForModal); if (!student) return null;
            const studentRecords = [];
            Object.entries(attendance).forEach(([date, records]) => { records.forEach(record => { if (record.studentId === selectedStudentForModal) { studentRecords.push({ ...record, date }); } }); });
            studentRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

            const handleDelete = (date, recordId) => { if(window.confirm('ì´ ì¶œê²° ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) setAttendance(prev => ({ ...prev, [date]: prev[date].filter(r => r.id !== recordId) })); };

            return (
              <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setSelectedStudentForModal(null)}>
                <div className="bg-[#fdfbf7] rounded-[2rem] w-full max-w-md max-h-[80vh] flex flex-col shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                  <div className="px-6 py-6 border-b border-stone-100 flex justify-between items-center bg-white">
                    <h3 className="text-xl font-extrabold text-stone-700 flex items-center"><Icon name="users" size={24} className="mr-3 text-emerald-500" />{student.name} <span className="text-stone-400 text-sm font-bold ml-2">í•™ìƒ ì¶œê²° ìƒì„¸</span></h3>
                    <button onClick={() => setSelectedStudentForModal(null)} className="p-2 hover:bg-stone-100 rounded-full transition-colors text-stone-400"><Icon name="x" size={20}/></button>
                  </div>
                  <div className="p-6 overflow-y-auto">
                    {studentRecords.length === 0 ? (<div className="text-center py-12 text-stone-400 bg-white rounded-3xl border border-dashed border-stone-200 font-medium shadow-sm">ê¸°ë¡ëœ ì¶œê²° ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>) : (
                      <div className="space-y-3">
                        {studentRecords.map(record => {
                          const isPaper = record.docType === 'paper' || record.docSubmitted; const isNeis = record.docType === 'neis';
                          return (
                            <div key={record.id} className="flex justify-between items-center p-4 border border-stone-100 rounded-2xl hover:border-emerald-200 hover:shadow-sm bg-white transition-all">
                              <div className="flex items-center gap-3">
                                <span className="font-extrabold text-stone-600">{record.date}</span>
                                <div className="flex flex-col items-start gap-1">
                                  <span className={`px-2.5 py-1 rounded-xl text-xs font-extrabold flex items-center gap-1 ${record.type === 'ê²°ì„' ? 'bg-rose-50 text-rose-500' : record.type === 'ì¡°í‡´' ? 'bg-amber-50 text-amber-500' : record.type === 'ì§€ê°' ? 'bg-indigo-50 text-indigo-500' : record.type === 'ê²°ê³¼' ? 'bg-violet-50 text-violet-500' : 'bg-sky-50 text-sky-500'}`}>
                                    {record.type}{record.subType ? `(${record.subType})` : ''} {record.period ? ` ${record.period}êµì‹œ` : ''}
                                  </span>
                                  {isPaper && (<span className="flex items-center gap-1 px-2 py-0.5 bg-emerald-50 border border-emerald-100 text-emerald-600 text-[11px] font-extrabold rounded-md"><Icon name="file-check" size={12} /> ì„œë¥˜ ì™„ë£Œ</span>)}
                                  {isNeis && (<span className="flex items-center gap-1 px-2 py-0.5 bg-blue-50 border border-blue-100 text-blue-600 text-[11px] font-extrabold rounded-md"><Icon name="monitor" size={12} /> NEIS ê²°ì¬</span>)}
                                </div>
                              </div>
                              <button onClick={() => handleDelete(record.date, record.id)} className="text-stone-300 hover:text-rose-400 transition-colors p-2 rounded-full hover:bg-rose-50"><Icon name="trash-2" size={18}/></button>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                  <div className="p-5 border-t border-stone-100 bg-white">
                    <button onClick={() => setSelectedStudentForModal(null)} className="w-full py-4 bg-stone-700 text-white font-bold rounded-2xl hover:bg-stone-800 active:scale-95 transition-all shadow-sm">ë‹«ê¸°</button>
                  </div>
                </div>
              </div>
            );
          };

          const renderEventEditModal = () => {
            if (!isEventModalOpen) return null;
            const handleAddEvent = () => {
              if (!evDate || !evName.trim()) return;
              if (evType === 'holiday') setHolidays(prev => ({ ...prev, [evDate]: evName })); else setCustomEvents(prev => ({ ...prev, [evDate]: evName }));
              setEvDate(''); setEvName('');
            };
            const handleDelete = (date, type) => {
              if (type === 'holiday') { const updated = { ...holidays }; delete updated[date]; setHolidays(updated); }
              else { const updated = { ...customEvents }; delete updated[date]; setCustomEvents(updated); }
            };
            const combinedEvents = [...Object.entries(holidays).map(([date, name]) => ({ date, name, type: 'holiday' })), ...Object.entries(customEvents).map(([date, name]) => ({ date, name, type: 'event' }))].sort((a, b) => a.date.localeCompare(b.date));

            return (
              <div className="fixed inset-0 bg-stone-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setIsEventModalOpen(false)}>
                <div className="bg-[#fdfbf7] rounded-[2rem] w-full max-w-md p-6 shadow-2xl flex flex-col max-h-[85vh]" onClick={e => e.stopPropagation()}>
                  <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-extrabold flex items-center gap-2 text-stone-700"><Icon name="calendar" className="text-emerald-500"/>í•™ì‚¬ì¼ì • í¸ì§‘</h3><button onClick={() => setIsEventModalOpen(false)} className="p-2 hover:bg-stone-200 rounded-full transition text-stone-400"><Icon name="x" size={20}/></button></div>
                  <div className="flex flex-col gap-3 mb-6 bg-white p-5 rounded-3xl border border-stone-100 shadow-sm">
                    <div className="flex gap-2">
                      <select value={evType} onChange={e => setEvType(e.target.value)} className="w-32 p-3 bg-stone-50 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-200 font-bold text-stone-600"><option value="event">ì¼ë°˜ì¼ì •</option><option value="holiday">ê³µíœ´ì¼(íœ´ì—…)</option></select>
                      <input type="date" value={evDate} onChange={e => setEvDate(e.target.value)} className="flex-1 p-3 bg-stone-50 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-200 font-medium text-stone-600" />
                    </div>
                    <input type="text" placeholder="ì¼ì • ì´ë¦„ (ì˜ˆ: í˜„ì¥ì²´í—˜í•™ìŠµ)" value={evName} onChange={e => setEvName(e.target.value)} className="w-full p-3 bg-stone-50 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-200 font-medium text-stone-600" />
                    <button onClick={handleAddEvent} className="w-full bg-emerald-500 text-white py-3.5 rounded-xl font-bold hover:bg-emerald-600 transition active:scale-95 flex justify-center items-center gap-2 mt-2 shadow-sm"><Icon name="plus" size={18} strokeWidth={3} /> ì¼ì • ì¶”ê°€í•˜ê¸°</button>
                  </div>
                  <div className="flex-1 overflow-y-auto space-y-3 pr-1 border-t border-stone-100 pt-5">
                    {combinedEvents.length === 0 ? (<p className="text-center text-sm text-stone-400 py-6 font-medium">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>) : (
                      combinedEvents.map((item) => (
                        <div key={`${item.date}-${item.type}`} className="flex justify-between items-center p-4 bg-white hover:bg-stone-50 rounded-2xl border border-stone-100 transition shadow-sm">
                          <div><div className="flex items-center gap-3"><span className={`text-[11px] px-2 py-1 rounded-lg font-extrabold ${item.type === 'holiday' ? 'bg-rose-50 text-rose-500' : 'bg-emerald-50 text-emerald-600'}`}>{item.type === 'holiday' ? 'ê³µíœ´ì¼' : 'ì¼ì •'}</span><span className="font-extrabold text-stone-600">{item.name}</span></div><div className="text-xs font-bold text-stone-400 mt-2">{item.date}</div></div>
                          <button onClick={() => handleDelete(item.date, item.type)} className="p-2.5 text-stone-300 hover:bg-rose-50 hover:text-rose-400 rounded-xl transition"><Icon name="trash-2" size={18} /></button>
                        </div>
                      ))
                    )}
                  </div>
                  <div className="mt-5 border-t border-stone-100 pt-5"><button onClick={() => setIsEventModalOpen(false)} className="w-full py-4 bg-stone-700 text-white font-bold rounded-2xl shadow-sm hover:bg-stone-800 active:scale-95 transition-all text-lg">ì™„ë£Œ ë° ë‹«ê¸°</button></div>
                </div>
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-[#fdfbf7] text-stone-800 pb-10">
              <nav className="bg-emerald-600 text-white shadow-sm border-b border-emerald-700/50">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex items-center justify-between h-16">
                    <div className="flex items-center">
                      <Icon name="notebook-pen" size={28} className="mr-3 text-emerald-100" />
                      <span className="font-extrabold text-xl tracking-wide">Teachers' Mate <span className="text-emerald-200 text-sm font-bold ml-1">(ë‹´ì„ver.)</span></span>
                    </div>
                    <div className="flex items-center gap-4">
                      <div className="hidden sm:flex text-sm font-bold text-emerald-100 items-center gap-2">
                         <Icon name="user" size={16} /> {user.displayName || 'ì„ ìƒë‹˜'}
                      </div>
                      <button onClick={handleLogout} className="px-3 py-1.5 bg-emerald-700/50 hover:bg-emerald-700 rounded-xl text-xs font-bold transition-colors flex items-center gap-1.5 shadow-inner">
                         <Icon name="log-out" size={14} /> ë¡œê·¸ì•„ì›ƒ
                      </button>
                    </div>
                  </div>
                </div>
                
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex space-x-2 overflow-x-auto pt-2 pb-0 scrollbar-hide">
                    {[
                      { id: 'calendar', name: 'í•™ì‚¬ë‹¬ë ¥', icon: 'calendar' },
                      { id: 'fieldTrip', name: 'êµì™¸ì²´í—˜ ë§¤ë‹ˆì €', icon: 'bus' },
                      { id: 'roster', name: 'ì¶œê²° í†µê³„', icon: 'users' },
                      { id: 'counseling', name: 'ìƒë‹´', icon: 'book-open' },
                      { id: 'timetable', name: 'ê¸°ì´ˆì‹œê°„í‘œ', icon: 'clock' },
                      { id: 'evaluation', name: 'í‰ê°€ê³„íš', icon: 'file-text' },
                    ].map(tab => (
                      <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center px-5 py-3 rounded-t-2xl transition-colors whitespace-nowrap text-sm font-bold ${activeTab === tab.id ? 'bg-[#fdfbf7] text-emerald-700 shadow-lg translate-y-px' : 'text-emerald-100 hover:bg-emerald-500'}`}>
                        <Icon name={tab.icon} size={18} className="mr-2" /> {tab.name}
                      </button>
                    ))}
                  </div>
                </div>
              </nav>

              <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {activeTab === 'calendar' && (
                  <div className="bg-white p-8 rounded-3xl shadow-sm border border-stone-100">
                    <div className="flex items-center justify-between mb-8">
                      <h2 className="text-2xl font-extrabold text-stone-700 flex items-center"><Icon name="calendar" className="mr-3 text-emerald-500"/>{currentDate.getFullYear()}ë…„ {currentDate.getMonth() + 1}ì›”</h2>
                      <div className="flex space-x-2">
                        <button onClick={() => setIsEventModalOpen(true)} className={`px-4 py-2 rounded-xl font-bold transition text-sm flex items-center gap-2 bg-stone-50 hover:bg-stone-100 text-stone-600`}><Icon name="edit-2" size={16} /> í•™ì‚¬ì¼ì • í¸ì§‘</button>
                        <div className="w-px bg-stone-200 mx-2 hidden sm:block"></div>
                        <button onClick={prevMonth} className="p-2.5 bg-stone-50 rounded-xl hover:bg-stone-100 transition text-stone-600"><Icon name="chevron-left" size={20}/></button>
                        <button onClick={() => setCurrentDate(new Date())} className="px-5 py-2.5 bg-emerald-50 text-emerald-600 rounded-xl hover:bg-emerald-100 font-bold transition text-sm">ì˜¤ëŠ˜</button>
                        <button onClick={nextMonth} className="p-2.5 bg-stone-50 rounded-xl hover:bg-stone-100 transition text-stone-600"><Icon name="chevron-right" size={20}/></button>
                      </div>
                    </div>
                    <div className="grid grid-cols-7 gap-3 mt-4">
                      {['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].map((day, i) => (<div key={day} className={`py-3 text-center font-extrabold text-sm rounded-xl mb-2 ${i === 0 ? 'text-rose-400 bg-rose-50/50' : i === 6 ? 'text-sky-400 bg-sky-50/50' : 'text-stone-500 bg-stone-50/50'}`}>{day}</div>))}
                      {renderCalendar()}
                    </div>
                  </div>
                )}
                {activeTab === 'fieldTrip' && renderFieldTrip()}
                {activeTab === 'roster' && (<div className="space-y-8">{renderRoster()}{renderRosterSetup()}</div>)}
                {activeTab === 'counseling' && renderCounseling()}
                {activeTab === 'timetable' && renderTimetable()}
                {activeTab === 'evaluation' && renderEvaluation()}
              </main>

              <footer className="w-full text-center pt-8 pb-4 text-stone-400 text-xs font-bold uppercase tracking-widest">&copy; 2026 Teachers' Mate. Secured by Firebase.</footer>

              {renderDailyModal()}
              {renderStudentDetailModal()}
              {renderEventEditModal()}
            </div>
          );
        }

        // --- ë¶€íŠ¸ìŠ¤íŠ¸ë© ì»´í¬ë„ŒíŠ¸ (ì¸ì¦ ë° Firebase ì¤€ë¹„ í™•ì¸) ---
        function App() {
          const [firebaseReady, setFirebaseReady] = useState(false);
          const [user, setUser] = useState(null);
          const [needsSetup, setNeedsSetup] = useState(false);
          const [db, setDb] = useState(null);
          const [isAuthChecking, setIsAuthChecking] = useState(true);

          useEffect(() => {
            const initFirebase = async () => {
              if (USER_FIREBASE_CONFIG.apiKey === "YOUR_API_KEY" && typeof __firebase_config === 'undefined') {
                setNeedsSetup(true);
                return;
              }
              const { initializeApp, getAuth, getFirestore, onAuthStateChanged } = window.FirebaseUtils;
              const app = initializeApp(firebaseConfig);
              const auth = getAuth(app);
              const firestore = getFirestore(app);
              setDb(firestore);

              // ë¡œê·¸ì¸ ì „ í™”ë©´ì„ ë„ì›Œì„œ ì‹œì—°í•  ìˆ˜ ìˆë„ë¡ ìë™ ë¡œê·¸ì¸ ëŒ€ê¸°
              onAuthStateChanged(auth, (u) => {
                setUser(u);
                setIsAuthChecking(false);
              });
              setFirebaseReady(true);
            };

            if (window.FirebaseUtils) initFirebase();
            else window.addEventListener('firebase-loaded', initFirebase);
            return () => window.removeEventListener('firebase-loaded', initFirebase);
          }, []);

          if (needsSetup) return <SetupGuideScreen />;
          if (!firebaseReady || isAuthChecking) return <div className="min-h-screen flex items-center justify-center bg-[#fdfbf7] text-stone-500 font-bold">ì¸ì¦ ì‹œìŠ¤í…œì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>;
          if (!user) return <LoginScreen />;
          
          return <MainApp user={user} db={db} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
